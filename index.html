<!DOCTYPE html><html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Route 23 – Fase 2</title><style>
  body { font-family: Arial, sans-serif; background: #ffffff; padding: 20px; text-align: center; }
  .logo { width: 80px; height: 80px; margin-bottom: 10px; }
  h1 { color: #1b3d2f; margin-bottom: 10px; }
  input { padding: 10px; margin: 5px; width: 90%; max-width: 400px; }
  button { padding: 10px; margin: 5px; width: 30%; min-width: 120px; background-color: #1b5e20; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
  ul { list-style: none; padding: 0; margin-top: 20px; }
  li { background-color: #f1f1f1; margin: 10px auto; padding: 10px; border-radius: 8px; width: 90%; max-width: 500px; cursor: grab; }
  #map { height: 400px; width: 100%; max-width: 600px; margin: 0 auto 20px; border-radius: 8px; }
  .btn-entrega { display: none; }
</style>

  </head>
  <body>
    <img src="https://i.imgur.com/NKvNknO.png" alt="Logo Route 23" class="logo" />
    <h1>Route 23</h1><div id="map"></div>

<input id="pedido" type="text" placeholder="Número do Pedido" />
<input id="endereco" type="text" placeholder="Endereço" />
<br />
<button onclick="adicionar()">Adicionar</button>
<button onclick="otimizarRota()">Otimizar Rota</button>
<button onclick="iniciarRota()">Iniciar Rota</button>

<ul id="lista"></ul>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmFD7MbQv11iUe0YmuKdpRcrwgqCeufvY&libraries=places&callback=initMap" async defer></script>

<script>
  let map, directionsService, directionsRenderer, autocomplete, sortable;
  let paradas = [], coordsParadas = [], routeStarted = false, markers = [];

  window.initMap = function () {
    map = new google.maps.Map(document.getElementById('map'), { center: { lat: -14.235, lng: -51.9253 }, zoom: 4 });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
    directionsRenderer.setMap(map);
    initAutocomplete();
  }

  function initAutocomplete() {
    autocomplete = new google.maps.places.Autocomplete(document.getElementById('endereco'), {
      types: ['geocode'],
      componentRestrictions: { country: 'br' },
      fields: ['formatted_address', 'geometry']
    });
  }

  function adicionar() {
    const pedido = document.getElementById('pedido').value.trim();
    const endereco = document.getElementById('endereco').value.trim();
    if (!pedido || !endereco) return;
    paradas.unshift({ id: Date.now(), pedido, endereco });
    atualizarLista();
    document.getElementById('pedido').value = '';
    document.getElementById('endereco').value = '';
  }

  function atualizarLista() {
    const lista = document.getElementById('lista');
    lista.innerHTML = '';
    paradas.forEach((p, i) => {
      const li = document.createElement('li');
      li.dataset.index = i;
      li.innerHTML = `<strong>Pedido:</strong> ${p.pedido}<br/><strong>Endereço:</strong> ${p.endereco}<br/><button class='btn-entrega' onclick='entregue(${i})'>Entregue</button> <button class='btn-entrega' onclick='naoEntregue(${i})'>Não Entregue</button>`;
      lista.appendChild(li);
    });
    document.querySelectorAll('.btn-entrega').forEach(b => b.style.display = routeStarted ? 'inline-block' : 'none');
    if (!sortable) sortable = new Sortable(lista, { animation: 150, onEnd: reorderByDOM });
  }

  function reorderByDOM() {
    const items = [...document.querySelectorAll('#lista li')];
    paradas = items.map(li => paradas[li.dataset.index]);
    items.forEach((li, i) => li.dataset.index = i);
    if (coordsParadas.length === paradas.length) coordsParadas = paradas.map((_, i) => coordsParadas[i]);
    desenharParadasNoMapa();
    desenharRotaCompleta();
  }

  function entregue(i) {
    paradas.splice(i, 1);
    coordsParadas.splice(i, 1);
    atualizarLista();
    desenharParadasNoMapa();
    desenharRotaCompleta();
    if (paradas[0]) navegar(paradas[0].endereco);
  }

  function naoEntregue(i) {
    paradas.push(paradas.splice(i, 1)[0]);
    coordsParadas.push(coordsParadas.splice(i, 1)[0]);
    atualizarLista();
    desenharParadasNoMapa();
    desenharRotaCompleta();
    if (paradas[0]) navegar(paradas[0].endereco);
  }

  function iniciarRota() {
    if (paradas.length === 0) return alert('Adicione pelo menos uma parada.');
    routeStarted = true;
    document.querySelectorAll('.btn-entrega').forEach(b => b.style.display = 'inline-block');
    navegar(paradas[0].endereco);
  }

  function navegar(endereco) {
    window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(endereco)}&travelmode=driving`, '_blank');
  }

  async function otimizarRota() {
    if (paradas.length < 2) return alert('Adicione ao menos dois endereços.');
    const coords = await Promise.all(paradas.map(p => obterCoordenadas(p.endereco)));
    if (coords.includes(null)) return alert('Erro ao geocodificar algum endereço.');
    const ordem = calcularOrdem(coords);
    paradas = ordem.map(i => paradas[i]);
    coordsParadas = ordem.map(i => coords[i]);
    atualizarLista();
    desenharParadasNoMapa();
    desenharRotaCompleta();
  }

  function obterCoordenadas(endereco) {
    return new Promise(resolve => {
      new google.maps.Geocoder().geocode({ address: endereco }, (res, status) => {
        if (status === 'OK') {
          const loc = res[0].geometry.location;
          resolve({ lat: loc.lat(), lng: loc.lng() });
        } else {
          console.error('Geocoder falhou:', status);
          resolve(null);
        }
      });
    });
  }

  function calcularOrdem(coords) {
    const n = coords.length, visitados = [0];
    while (visitados.length < n) {
      const last = visitados[visitados.length - 1];
      let prox = -1, best = Infinity;
      for (let i = 0; i < n; i++) {
        if (visitados.includes(i)) continue;
        const d = Math.hypot(coords[last].lat - coords[i].lat, coords[last].lng - coords[i].lng);
        if (d < best) { best = d; prox = i; }
      }
      visitados.push(prox);
    }
    return visitados;
  }

  function desenharParadasNoMapa() {
    markers.forEach(m => m.setMap(null));
    markers = [];
    if (!coordsParadas.length) return;
    const bounds = new google.maps.LatLngBounds();
    coordsParadas.forEach((coord, i) => {
      const mk = new google.maps.Marker({ position: coord, map, label: String(i + 1) });
      markers.push(mk);
      bounds.extend(coord);
    });
    map.fitBounds(bounds);
  }

  function desenharRotaCompleta() {
    if (paradas.length < 2) return;
    directionsService.route({
      origin: paradas[0].endereco,
      destination: paradas[paradas.length - 1].endereco,
      waypoints: paradas.slice(1, -1).map(p => ({ location: p.endereco, stopover: true })),
      travelMode: google.maps.TravelMode.DRIVING
    }, (res, status) => {
      if (status === 'OK') directionsRenderer.setDirections(res);
      else console.error('Directions falhou:', status);
    });
  }
</script>

  </body>
</html>
