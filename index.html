<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Route 23 v2.8</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
:root{--verde:#1b5e20;--bg:#fff;--cinza:#f1f1f1;--bordas:12px}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,system-ui;background:var(--bg);display:flex;flex-direction:column;align-items:center;padding:0 var(--bordas)}
#map{width:100%;height:45vh;min-height:300px;border:1px solid #ccc;border-radius:8px;margin-top:6px}
#formulario{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;padding:10px 0;width:100%;max-width:700px}
input,button{padding:8px;border:1px solid #ccc;border-radius:6px;font-size:14px}
input{flex:1 1 180px}
button{background:var(--verde);color:#fff;border:none;cursor:pointer}
ul{list-style:none;padding:0;margin:10px auto;width:100%;max-width:700px}
li{background:var(--cinza);margin:6px 0;padding:8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;cursor:grab;transition:opacity .4s}
li.entregue{opacity:.4}
.info{text-align:left;max-width:70%;word-break:break-word}
.icon-btn{background:none;border:none;color:var(--verde);font-size:18px;cursor:pointer;margin-left:6px}
#overlay{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);background:#fff;padding:8px 12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.25);display:none;gap:8px;z-index:999}
#menu{position:fixed;top:70px;right:20px;background:#fff;border:1px solid #ccc;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.25);display:none;flex-direction:column;z-index:998}
#menu button{background:none;color:#333;border:none;padding:10px 16px;font-size:14px;text-align:left;width:200px;border-bottom:1px solid #eee}
#menu button:last-child{border-bottom:none}
#menu button:hover{background:var(--cinza)}
#splash{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;background:#fff;z-index:1000}
</style>
</head>
<body>
<div id="splash"><img src="logo.png" style="width:120px" alt="logo"></div>

<div id="map"></div>

<div style="display:flex;gap:8px;margin:8px 0">
  <button onclick="novaRota()" style="background:#d32f2f"><i class="fa-solid fa-broom"></i> Nova rota</button>
  <button id="btn-iniciar" onclick="iniciar()"><i class="fa-solid fa-play"></i> Iniciar rota</button>
</div>

<div id="formulario">
  <input id="endereco" placeholder="Endereço">
  <button id="btn-voz" title="Falar endereço"><i class="fa-solid fa-microphone"></i></button>

  <input id="pedido" placeholder="Nº do Pedido (opcional)">
  <button id="btn-menu" title="Mais opções"><i class="fa-solid fa-bars"></i></button>

  <input id="partida" placeholder="Ponto de Partida (opcional)">
  <button onclick="usarGPS()" title="GPS"><i class="fa-solid fa-location-crosshairs"></i></button>

  <button onclick="adicionar()"><i class="fa-solid fa-plus"></i></button>
  <button onclick="otimizar()"><i class="fa-solid fa-sort"></i></button>
</div>

<ul id="lista"></ul>

<div id="overlay">
  <button onclick="status('entregue')">Entregue</button>
  <button onclick="status('nao')">Não Entregue</button>
</div>

<div id="menu">
  <button onclick="inverter()"><i class="fa-solid fa-arrows-up-down"></i> Inverter rota</button>
  <button onclick="showParadas()"><i class="fa-solid fa-list"></i> Lista de paradas</button>
  <button onclick="showPedidos()"><i class="fa-solid fa-box"></i> Lista de pedidos</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmFD7MbQv11iUe0YmuKdpRcrwgqCeufvY&libraries=places&callback=initMap" async defer></script>
<script>
let map,svc,rend,acEnd,acStart,sortable;
let paradas=[],coords=[],markers=[];
let startLabel=null,startCoords=null,overlayOn=false;
const LS='r23_paradas',LS_S='r23_start',LS_OV='r23_overlay';

function initMap(){
  map=new google.maps.Map(document.getElementById('map'),{center:{lat:-14.2,lng:-51.9},zoom:4});
  svc=new google.maps.DirectionsService();
  rend=new google.maps.DirectionsRenderer({suppressMarkers:true});rend.setMap(map);
  acEnd=new google.maps.places.Autocomplete(document.getElementById('endereco'),{componentRestrictions:{country:'br'}});
  acStart=new google.maps.places.Autocomplete(document.getElementById('partida'),{componentRestrictions:{country:'br'}});
  document.getElementById('splash').style.display='none';
  load();
  if(localStorage.getItem(LS_OV)==='1'){overlayOn=true;document.getElementById('overlay').style.display='flex';}
}

const save=()=>{localStorage.setItem(LS,JSON.stringify(paradas));localStorage.setItem(LS_S,JSON.stringify({startLabel,startCoords}));localStorage.setItem(LS_OV,overlayOn?'1':'0');}
function load(){paradas=JSON.parse(localStorage.getItem(LS)||'[]');coords=paradas.map(p=>p.coords);const s=JSON.parse(localStorage.getItem(LS_S)||'null');if(s){startLabel=s.startLabel;startCoords=s.startCoords;document.getElementById('partida').value=startLabel||'';}refresh();drawAll();}
const geo=a=>new Promise(r=>new google.maps.Geocoder().geocode({address:a},(res,s)=>s==='OK'?r({lat:res[0].geometry.location.lat(),lng:res[0].geometry.location.lng()}):r(null)));

window.novaRota=()=>{paradas=[];coords=[];overlayOn=false;document.getElementById('overlay').style.display='none';refresh();drawAll();save();}

window.adicionar=async()=>{const end=endereco.value.trim();if(!end)return;const ped=pedido.value.trim();const c=await geo(end);paradas.unshift({pedido:ped,endereco:end,coords:c,done:false});coords.unshift(c);endereco.value='';pedido.value='';refresh();drawAll();save();}
window.duplicar=i=>{const np=prompt('Novo nº pedido',paradas[i].pedido||'');if(np===null)return;paradas.splice(i+1,0,{...paradas[i],pedido:np,done:false});coords.splice(i+1,0,coords[i]);refresh();save();}
window.editar=async i=>{const ne=prompt('Novo endereço',paradas[i].endereco);if(ne===null)return;const np=prompt('Novo nº pedido',paradas[i].pedido||'');if(np===null)return;const c=await geo(ne);paradas[i]={pedido:np,endereco:ne,coords:c,done:false};coords[i]=c;refresh();drawAll();save();}
window.excluir=i=>{paradas.splice(i,1);coords.splice(i,1);refresh();drawAll();save();}
window.navTo=i=>openNav(paradas[i].endereco);

function refresh(){
  const ul=lista;ul.innerHTML='';
  paradas.forEach((p,i)=>{
    const li=document.createElement('li');if(p.done)li.classList.add('entregue');
    li.innerHTML=`<div class='info'><strong>${p.pedido||'-'}</strong><br>${p.endereco}</div>
      <div>
        <button class='icon-btn' onclick='navTo(${i})'><i class=\"fa-solid fa-turn-up\"></i></button>
        <button class='icon-btn' onclick='duplicar(${i})'><i class='fa-solid fa-clone'></i></button>
        <button class='icon-btn' onclick='editar(${i})'><i class='fa-solid fa-pen'></i></button>
        <button class='icon-btn' onclick='excluir(${i})'><i class='fa-solid fa-trash'></i></button>
      </div>`;ul.appendChild(li);
  });
  if(sortable)sortable.destroy();
  sortable=new Sortable(ul,{animation:150,onEnd:()=>{
    const idx=[...ul.children].map(li=>[...ul.children].indexOf(li));
    paradas=idx.map(j=>paradas[j]);coords=paradas.map(p=>p.coords);refresh();drawAll();save();
  }});
}

window.usarGPS=()=>navigator.geolocation.getCurrentPosition(p=>{startCoords={lat:p.coords.latitude,lng:p.coords.longitude};startLabel='GPS';partida.value='GPS';drawAll();save();});
const order=c=>{const n=c.length,v=[0];while(v.length<n){const last=v.at(-1);let best=1e9,next=-1;for(let i=0;i<n;i++){if(v.includes(i))continue;const d=Math.hypot(c[last].lat-c[i].lat,c[last].lng-c[i].lng);if(d<best){best=d;next=i;}}v.push(next);}return v;};
window.otimizar=()=>{if(coords.length<2)return;const o=order(coords);paradas=o.map(i=>paradas[i]);coords=o.map(i=>coords[i]);refresh();drawAll();save();}
window.inverter=()=>{paradas.reverse();coords.reverse();refresh();drawAll();save();menu.style.display='none';}

function drawAll(){
  markers.forEach(m=>m.setMap(null));markers=[];
  const b=new google.maps.LatLngBounds();
  if(startCoords){markers.push(new google.maps.Marker({position:startCoords,map,label:'S'}));b.extend(startCoords);}
  coords.forEach((c,i)=>{if(!c)return;markers.push(new google.maps.Marker({position:c,map,label:String(i+1)}));b.extend(c);});
  if(!b.isEmpty())map.fitBounds(b);
  if(startCoords&&coords.length)svc.route({origin:startCoords,destination:paradas.at(-1).endereco,waypoints:paradas.slice(0,-1).map(p=>({location:p.endereco,stopover:true})),travelMode:'DRIVING'},(res,s)=>s==='OK'&&rend.setDirections(res));
}

const openNav=dest=>location.href=`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=driving&dir_action=navigate`;
window.iniciar=()=>{if(!paradas.length)return alert('Sem paradas');overlay.style.display='flex';overlayOn=true;save();openNav(paradas[0].endereco);}
window.status=t=>{paradas[0].done=true;if(t==='nao'){paradas.push(paradas.shift());coords.push(coords.shift());}refresh();drawAll();save();if(paradas.length)openNav(paradas[0].endereco);}

const menu=document.getElementById('menu');btn-menu.onclick=()=>menu.style.display=menu.style.display==='flex'?'none':'flex';
window.showParadas=()=>{alert(paradas.map((p,i)=>`${i+1}. ${p.pedido||'-'}\n${p.endereco}`).join('\\n\\n'));menu.style.display='none';}
window.showPedidos=()=>{alert(paradas.slice().reverse().map((p,i)=>`${i+1}. ${p.pedido||'-'}`).join('\\n'));menu.style.display='none';}

if('webkitSpeechRecognition'in window||'SpeechRecognition'in window){
  const SR=SpeechRecognition||webkitSpeechRecognition;const rec=new SR();rec.lang='pt-BR';
  btn-voz.onclick=()=>rec.start();rec.onresult=e=>endereco.value=e.results[0][0].transcript;
}
</script>
</body>
</html>
