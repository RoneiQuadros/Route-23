<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Route 23 – Fase 2.2</title>

    <!-- Font Awesome para ícones -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <style>
      :root {
        --verde: #1b5e20;
      }

      /* layout geral */
      body {
        font-family: Arial, system-ui;
        background: #fff;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      header {
        padding: 10px;
        text-align: center;
      }
      .logo {
        width: 110px;
        height: auto;
      }
      h1 {
        margin: 6px 0;
        color: #1b3d2f;
      }

      /* mapa ocupa toda a largura disponível */
      #map {
        flex: 1 1 auto;
        width: 100%;
        height: 45vh;           /* metade da altura da tela */
        min-height: 300px;
        border-top: 1px solid #ccc;
      }

      /* formulário e botões */
      #formulario {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        padding: 10px 0;
        gap: 6px;
        width: 100%;
        max-width: 700px;
      }
      input,
      button {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 14px;
      }
      input {
        flex: 1 1 180px;
      }
      button {
        background: var(--verde);
        color: #fff;
        border: none;
        cursor: pointer;
        min-width: 90px;
      }

      /* lista de paradas */
      ul {
        list-style: none;
        padding: 0;
        margin: 10px auto;
        width: 100%;
        max-width: 700px;
      }
      li {
        background: #f1f1f1;
        margin: 6px 0;
        padding: 8px 10px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: grab;
      }
      .info {
        text-align: left;
        max-width: 75%;
        word-break: break-word;
      }
      .icon-btn {
        background: none;
        border: none;
        color: var(--verde);
        font-size: 18px;
        cursor: pointer;
        margin-left: 6px;
      }

      /* overlay Entregue / Não Entregue */
      #overlay-controls {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 12px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
        display: none; /* aparece só depois de iniciar rota */
        z-index: 999;
      }
      #overlay-controls button {
        min-width: 100px;
        margin: 0 4px;
      }
    </style>
  </head>

  <body>
    <!-- cabeçalho -->
    <header>
      <img src="logo.png" class="logo" alt="Logo Route 23" />
      <h1>Route 23</h1>
    </header>

    <!-- mapa -->
    <div id="map"></div>

    <!-- formulário -->
    <div id="formulario">
      <input id="partida" placeholder="Ponto de Partida (opcional)" />
      <button onclick="usarMinhaLocalizacao()" title="GPS">
        <i class="fa-solid fa-location-crosshairs"></i>
      </button>

      <input id="pedido" placeholder="Nº do Pedido" />
      <input id="endereco" placeholder="Endereço" />

      <button onclick="adicionar()">
        <i class="fa-solid fa-plus"></i> Add
      </button>
      <button onclick="otimizarRota()">Otimizar</button>
      <button onclick="iniciarRota()">Iniciar Rota</button>
    </div>

    <!-- lista -->
    <ul id="lista"></ul>

    <!-- overlay -->
    <div id="overlay-controls">
      <button onclick="statusEntrega('entregue')">Entregue</button>
      <button onclick="statusEntrega('nao')">Não Entregue</button>
    </div>

    <!-- dependências -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmFD7MbQv11iUe0YmuKdpRcrwgqCeufvY&libraries=places&callback=initMap"
      async
      defer
    ></script>

    <script>
      /* ======= variáveis & localStorage ======= */
      let map,
        dirService,
        dirRenderer,
        autocomplete,
        sortable,
        paradas = [],
        markers = [],
        coordsParadas = [],
        pontoPartida = null,
        coordsPartida = null,
        routeStarted = false;

      const LS_KEY = "route23_paradas";
      const LS_KEY_PARTIDA = "route23_partida";

      /* ======= inicialização Google Maps ======= */
      window.initMap = () => {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: -14.235, lng: -51.9253 },
          zoom: 4,
        });

        dirService = new google.maps.DirectionsService();
        dirRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
        dirRenderer.setMap(map);

        autocomplete = new google.maps.places.Autocomplete(
          document.getElementById("endereco"),
          {
            types: ["geocode"],
            componentRestrictions: { country: "br" },
            fields: ["formatted_address", "geometry"],
          }
        );

        carregarLocalStorage();
      };

      /* ======= util ======= */
      const geocode = (addr) =>
        new Promise((res) =>
          new google.maps.Geocoder().geocode({ address: addr }, (r, s) => {
            if (s === "OK") {
              const l = r[0].geometry.location;
              res({ lat: l.lat(), lng: l.lng() });
            } else res(null);
          })
        );

      const ordemVizinho = (c) => {
        const n = c.length,
          v = [0];
        while (v.length < n) {
          const last = v[v.length - 1];
          let p = -1,
            best = 1e9;
          for (let i = 0; i < n; i++) {
            if (v.includes(i)) continue;
            const d = Math.hypot(
              c[last].lat - c[i].lat,
              c[last].lng - c[i].lng
            );
            if (d < best) {
              best = d;
              p = i;
            }
          }
          v.push(p);
        }
        return v;
      };

      /* ======= localStorage ======= */
      function salvarLS() {
        localStorage.setItem(LS_KEY, JSON.stringify(paradas));
        localStorage.setItem(
          LS_KEY_PARTIDA,
          JSON.stringify({ pontoPartida, coordsPartida })
        );
      }

      async function carregarLocalStorage() {
        const saved = localStorage.getItem(LS_KEY);
        if (saved) {
          paradas = JSON.parse(saved);
          // recarrega coordenadas
          await Promise.all(
            paradas.map(async (p) => (p.coords = await geocode(p.endereco)))
          );
          coordsParadas = paradas.map((p) => p.coords);
          atualizarLista();
        }

        const start = localStorage.getItem(LS_KEY_PARTIDA);
        if (start) {
          const d = JSON.parse(start);
          pontoPartida = d.pontoPartida;
          coordsPartida = d.coordsPartida;
          if (pontoPartida) document.getElementById("partida").value = pontoPartida;
        }

        desenharParadasNoMapa();
        desenharRotaCompleta();
      }

      /* ======= partida ======= */
      function usarMinhaLocalizacao() {
        if (!navigator.geolocation) return alert("Sem GPS");
        navigator.geolocation.getCurrentPosition((pos) => {
          coordsPartida = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
          };
          pontoPartida = "GPS";
          document.getElementById("partida").value = "GPS";
          desenharParadasNoMapa();
          desenharRotaCompleta();
          salvarLS();
        });
      }

      /* ======= CRUD paradas ======= */
      async function adicionar() {
        const pedido = document.getElementById("pedido").value.trim();
        const end = document.getElementById("endereco").value.trim();
        if (!pedido || !end) return;

        const coords = await geocode(end);
        paradas.unshift({ pedido, endereco: end, coords });
        coordsParadas.unshift(coords);

        document.getElementById("pedido").value = "";
        document.getElementById("endereco").value = "";

        atualizarLista();
        desenharParadasNoMapa();
        desenharRotaCompleta();
        salvarLS();
      }

      function duplicar(i) {
        paradas.splice(i + 1, 0, { ...paradas[i] });
        coordsParadas.splice(i + 1, 0, { ...coordsParadas[i] });
        atualizarLista();
        salvarLS();
      }

      function excluir(i) {
        paradas.splice(i, 1);
        coordsParadas.splice(i, 1);
        atualizarLista();
        desenharParadasNoMapa();
        desenharRotaCompleta();
        salvarLS();
      }

      function atualizarLista() {
        const ul = document.getElementById("lista");
        ul.innerHTML = "";

        paradas.forEach((p, i) => {
          const li = document.createElement("li");
          li.dataset.index = i;
          li.innerHTML = `
            <div class='info'>
              <strong>${p.pedido}</strong><br>${p.endereco}
            </div>
            <div>
              <button class='icon-btn' onclick='duplicar(${i})'><i class='fa-solid fa-clone'></i></button>
              <button class='icon-btn' onclick='excluir(${i})'><i class='fa-solid fa-trash'></i></button>
            </div>
          `;
          ul.appendChild(li);
        });

        if (!sortable)
          sortable = new Sortable(ul, { animation: 150, onEnd: reorderDom });
      }

      function reorderDom() {
        const lis = [...document.querySelectorAll("#lista li")];
        paradas = lis.map((li) => paradas[li.dataset.index]);
        coordsParadas = lis.map((li) => coordsParadas[li.dataset.index]);
        desenharParadasNoMapa();
        desenharRotaCompleta();
        salvarLS();
      }

      /* ======= otimizar & rota ======= */
      async function otimizarRota() {
        if (paradas.length < 2) return alert("Adicione 2+ paradas");
        await prepararPartida();

        const ordem = ordemVizinho(coordsParadas);
        paradas = ordem.map((i) => paradas[i]);
        coordsParadas = ordem.map((i) => coordsParadas[i]);

        atualizarLista();
        desenharParadasNoMapa();
        desenharRotaCompleta();
        salvarLS();
      }

      async function prepararPartida() {
        const txt = document.getElementById("partida").value.trim();
        if (txt) {
          pontoPartida = txt;
          coordsPartida = await geocode(txt);
          salvarLS();
        }
      }

      /* ======= mapa ======= */
      function desenharParadasNoMapa() {
        markers.forEach((m) => m.setMap(null));
        markers = [];

        const bounds = new google.maps.LatLngBounds();

        if (coordsPartida) {
          const mk = new google.maps.Marker({
            position: coordsPartida,
            map,
            label: "S",
          });
          markers.push(mk);
          bounds.extend(coordsPartida);
        }

        coordsParadas.forEach((c, i) => {
          if (!c) return;
          const mk = new google.maps.Marker({
            position: c,
            map,
            label: String(i + 1),
          });
          markers.push(mk);
          bounds.extend(c);
        });

        if (!bounds.isEmpty()) map.fitBounds(bounds);
      }

      function desenharRotaCompleta() {
        if (!coordsPartida || coordsParadas.length < 1) return;

        dirService.route(
          {
            origin: coordsPartida,
            destination: paradas[paradas.length - 1].endereco,
            waypoints: paradas.slice(0, -1).map((p) => ({
              location: p.endereco,
              stopover: true,
            })),
            travelMode: google.maps.TravelMode.DRIVING,
          },
          (res, status) => {
            if (status === "OK") dirRenderer.setDirections(res);
          }
        );
      }

      /* ======= navegação ======= */
      function iniciarRota() {
        if (paradas.length === 0) return alert("Sem paradas");
        routeStarted = true;
        document.getElementById("overlay-controls").style.display = "block";
        abrirNavegacao(paradas[0].endereco);
      }

      function statusEntrega(tipo) {
        if (tipo === "entregue") {
          paradas.shift();
          coordsParadas.shift();
        } else {
          paradas.push(paradas.shift());
          coordsParadas.push(coordsParadas.shift());
        }

        if (paradas.length === 0) {
          document.getElementById("overlay-controls").style.display = "none";
          routeStarted = false;
          salvarLS();
          return;
        }

        desenharParadasNoMapa();
        desenharRotaCompleta();
        abrirNavegacao(paradas[0].endereco);
        atualizarLista();
      }

      // abre navegação no próprio Maps app / browser
      function abrirNavegacao(dest) {
        const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(
          dest
        )}&travelmode=driving&dir_action=navigate`;
        window.location.href = url;
      }
    </script>
  </body>
</html>
