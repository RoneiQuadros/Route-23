<!-- Route 23 – versão compacta com correções 2025‑07‑10 --><!DOCTYPE html><html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Route 23</title>
  <!-- ► Tailwind via CDN para estilos utilitários rápidos -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* --- ajustes do app --- */
    body {
      @apply bg-white text-gray-900 select-none;
    }
    /* pequena borda nas laterais para facilitar o scroll */
    #app {
      @apply px-2;
    }
    /* mapa ocupa altura flexível */
    #map {
      height: 45vh; /* ajuste conforme desejar */
      width: 100%;
    }
    /* lista de paradas */
    .stop-item {
      @apply flex justify-between items-start bg-white rounded-lg shadow p-2 mb-2;
    }
    .stop-item.opacity-40 {
      @apply opacity-40 pointer-events-none;
    }
    /* botões de ação – 30% da largura, centralizados */
    .action-btn {
      @apply w-[30%] mx-auto py-1 rounded-lg text-white font-semibold;
    }
  </style>
</head>
<body>
  <div id="app" class="max-w-lg mx-auto">
    <!-- Mapa -->
    <div id="map" class="rounded-lg shadow mb-4"></div><!-- Formulário para adicionar parada -->
<form id="addForm" class="space-y-2 mb-4">
  <input id="address" class="w-full input input-bordered" placeholder="Endereço" required />
  <input id="order" class="w-full input input-bordered" placeholder="Nº do pedido (opcional)" />
  <input id="start" class="w-full input input-bordered" placeholder="Ponto de partida (opcional)" />
  <div class="flex gap-2">
    <button class="action-btn bg-emerald-700">Adicionar</button>
    <button type="button" id="optimizeBtn" class="action-btn bg-emerald-700">Otimizar rota</button>
    <button type="button" id="startRouteBtn" class="action-btn bg-emerald-700">Iniciar rota</button>
  </div>
</form>

<!-- Lista de paradas -->
<ul id="stopList"></ul>

  </div>  <!-- Google Maps – substitua SUA_API_KEY abaixo -->  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmFD7MbQv11iUe0YmuKdpRcrwgqCeufvY&libraries=places"></script>  <script>
  /* =============================================================
     Route 23 – script principal
     ============================================================= */
  let map, geocoder, directionsService, directionsRenderer;
  let stops = [];           // {id, address, order, start, status, latLng}
  let routeStarted = false; // para exibir Entregue / Não entregue

  /*** Utilidades ***********************************************************/
  const qs = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const uid = () => Date.now().toString(36) + Math.random().toString(36).substr(2,5);

  function saveStops() {
    localStorage.setItem('stops', JSON.stringify(stops));
  }
  function loadStops() {
    stops = JSON.parse(localStorage.getItem('stops') || '[]');
  }

  /*** Mapa *****************************************************************/
  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: -29.6, lng: -51.15 }, // Ivoti‑RS como padrão
      zoom: 13,
      mapTypeControl: false,
    });
    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ map });
  }

  async function geocodeAddress(address) {
    return new Promise((resolve, reject) => {
      geocoder.geocode({ address }, (results, status) => {
        if (status === 'OK' && results[0]) {
          resolve(results[0].geometry.location);
        } else {
          reject(status);
        }
      });
    });
  }

  async function drawMarkers() {
    // remove rota, desenha marcadores simples numerados
    directionsRenderer.set('directions', null);
    map.overlayMapTypes.clear?.();
    // limpar marcadores existentes
    $$('[data-marker]').forEach(el => el.setMap(null));

    const bounds = new google.maps.LatLngBounds();
    stops.forEach((s, idx) => {
      if (!s.latLng) return;
      const marker = new google.maps.Marker({
        position: s.latLng,
        map,
        label: (idx + 1).toString(),
      });
      marker.__id = s.id;
      marker.set("data-marker", true);
      bounds.extend(s.latLng);
    });
    map.fitBounds(bounds);
  }

  /*** Renderização da lista ***********************************************/
  function renderStopList() {
    const ul = qs('#stopList');
    ul.innerHTML = stops.map(s => {
      const deliveredClass = s.status ? 'opacity-40' : '';
      return `
      <li class="stop-item ${deliveredClass}" data-id="${s.id}">
        <div>
          <p class="font-medium">${s.address}</p>
          ${s.order ? `<p class="text-sm text-gray-500">Pedido #${s.order}</p>` : ''}
        </div>
        <div class="flex flex-col gap-1 ml-2">
          <button class="btn-nav" data-id="${s.id}">⬆️</button>
          <button class="btn-edit" data-id="${s.id}">✏️</button>
          <button class="btn-dup" data-id="${s.id}">📄</button>
          <button class="btn-delete" data-id="${s.id}">🗑️</button>
          ${routeStarted ? `
            <button class="btn-delivered" data-id="${s.id}">✅</button>
            <button class="btn-undelivered" data-id="${s.id}">❌</button>` : ''}
        </div>
      </li>`;
    }).join('');
  }

  /***** Ações nos botões ***************************************************/
  function bindListDelegation() {
    qs('#stopList').addEventListener('click', async (e) => {
      const id = e.target.dataset.id;
      if (!id) return;
      if (e.target.matches('.btn-delete')) deleteStop(id);
      else if (e.target.matches('.btn-edit')) editStop(id);
      else if (e.target.matches('.btn-dup')) duplicateStop(id);
      else if (e.target.matches('.btn-nav')) navigateToStop(id);
      else if (e.target.matches('.btn-delivered')) markStop(id, 'delivered');
      else if (e.target.matches('.btn-undelivered')) markStop(id, 'undelivered');
    });
  }

  function deleteStop(id) {
    stops = stops.filter(s => s.id !== id);
    saveStops();
    renderStopList();
    drawMarkers();
  }
  function duplicateStop(id) {
    const src = stops.find(s => s.id === id);
    const copy = { ...src, id: uid() };
    stops.push(copy);
    saveStops();
    renderStopList();
    drawMarkers();
  }
  function editStop(id) {
    const s = stops.find(st => st.id === id);
    const newAddr = prompt('Editar endereço', s.address);
    if (newAddr) {
      s.address = newAddr;
      s.latLng = null; // forçar nova geocodificação
      saveStops();
      renderStopList();
      geocodeAndUpdate(s);
    }
  }
  function navigateToStop(id) {
    const s = stops.find(st => st.id === id);
    if (!s) return;
    const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(s.address)}&travelmode=driving`;
    window.open(url, '_blank');
  }
  function markStop(id, status) {
    const s = stops.find(st => st.id === id);
    if (!s) return;
    s.status = status;
    saveStops();
    renderStopList();
  }

  /***** Formulário de adição **********************************************/
  async function geocodeAndUpdate(stop) {
    try {
      stop.latLng = await geocodeAddress(stop.address);
      saveStops();
      drawMarkers();
    } catch(err) {
      alert('Não foi possível localizar o endereço: ' + err);
    }
  }

  function handleAdd(e) {
    e.preventDefault();
    const address = qs('#address').value.trim();
    if (!address) return;
    const order = qs('#order').value.trim();
    const start = qs('#start').value.trim();

    const stop = { id: uid(), address, order, start, status: null, latLng: null };
    stops.push(stop);
    saveStops();
    renderStopList();
    geocodeAndUpdate(stop);

    e.target.reset();
  }

  /***** Otimizar rota ******************************************************/
  async function optimizeRoute() {
    if (stops.length < 2) return alert('Adicione pelo menos 2 paradas.');

    // pontos origem e destino – se houver "start" marcado, usa; senão, primeira parada
    const origin = stops[0].address;
    const destination = stops[stops.length - 1].address;
    const waypoints = stops.slice(1, -1).map(s => ({ location: s.address, stopover: true }));

    directionsService.route({
      origin, destination, waypoints, travelMode: 'DRIVING', optimizeWaypoints: true
    }, (result, status) => {
      if (status === 'OK') {
        directionsRenderer.setDirections(result);
      } else {
        alert('Erro ao otimizar rota: ' + status);
      }
    });
  }

  /***** Iniciar rota ******************************************************/
  function startRoute() {
    if (stops.length === 0) return alert('Nenhuma parada adicionada.');
    routeStarted = true;
    renderStopList();
    navigateToStop(stops[0].id);
  }

  /***** Inicialização ******************************************************/
  document.addEventListener('DOMContentLoaded', () => {
    initMap();
    loadStops();
    renderStopList();
    drawMarkers();

    bindListDelegation();
    qs('#addForm').addEventListener('submit', handleAdd);
    qs('#optimizeBtn').addEventListener('click', optimizeRoute);
    qs('#startRouteBtn').addEventListener('click', startRoute);
  });
  </script></body>
</html>
